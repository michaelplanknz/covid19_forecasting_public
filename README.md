# Forecasting Covid-19 cases and hopsitalisations in Aotearoa New Zealand

Public repository containing a model for forecasting Covid-19 cases, admissions and hospital occupancy in New Zealand. 

This repository contains supporting data and Matlab code for the article "Near-term forecasting of Covid-19 cases and hopsitalisations in Aotearoa New Zealand" by Plank et al. 



# Running the model

Forecasts can be produced nationally, regionally, or for a specified Health District.

**NB Due to privacy reasons, only national-level data are available in this public repository.**

To run the model:
* `runLatest.m` fits the model and produces a forecast for a specified area or list of areas (national, Regions, or Health Districts) from a single dataset. 
* `runAll.m` fits the model and produces forecasts for a SINGLE specified area, using data at a series of weekly timepoints and compare them to subsequently observed data. 
Results files will be saved in the `results` folder and graphs in the `figures` folder.

The forecast date and areas can be specified by setting the following variables in `runLatest.m`:
* areaName - list of areas for forecast, with each entry either "National" for a national forecast, "Northern_region", "Midland_region", "Central_region" or "Southern_region" for a regional forecast, or one of 18 specified Health Districts (use with caution, especially for smaller Health Districts)
* readDate - date stamp on data file (allData_YYYY-MM-DD.mat) to use to generate forecast
* testDate - date stamp on data file (allData_YYYY-MM-DD.mat) to use to test forecast (can be the same as or later than readDate)


# Data

The `data` folder contains datasets generated from EpiSurv/community case data supplied by MOH on one of a series of weekly time points, plus hospital occupancy data downloaded from https://github.com/minhealthnz/nz-covid-data/tree/main/cases.

The required data files that the model reads in are as follows:

* covid-cases-in-hospital-counts-location.xlsx contains time series for hospital occupancy in each Health District, downloaded from https://github.com/minhealthnz/nz-covid-data/tree/main/cases

* epiData_YYYY-MM-DD.csv contains time series for:
1. nCasesByAge_i     the number of cases reported in age group i on day t. 
2. nHospByAge_DOR_i  the number of new daily admissions in age group i with a case report date on day t. 
3. nHospByAge_DOA_i  the number of new daily admissions in age group i with date of admission on day t.
4. nDiscByAge_i      the number of cases in age group i with modelled discharge date on day t.
   
There are ten 10-year age groups (0-10, 10-20, ..., 90+) nationally, for each of the four Regions, and for each Health District (as specified by the areaName field).

* OtoRData_YYYY-MM-DD.csv contains the number of cases nationally whose report date was k days after their recorded symptom onset data during the relevant time period (see Methods).

* RtoAData_YYYY-MM-DD.csv contains the number of admissions nationally whose admission date was k days after their report date during the relevant time period (see Methods).

* LOSData_YYYY-MM-DD.csv contains the number of admissions nationally in each age group with length of stay = 0, 1, 2, ..., 56 days during the relevant time period (see Methods).

* allData_YYYY-MM-DD.mat is a Matlab .mat binary containing all the above datasets - this is the data file that is read in by the code (the .csv files referred to above are for convenience and portability only). The .mat file contains the following variables:
  - epiData - a Matlab table with the epidemiological time series described above
  - OtoR_array & OtoR_freq - OtoR_freq(i) is the frequency of cases with onset to reprot time = OtoR_array(i)
  - RtoA_array & RtoA_frew - RtoA_freq(i) is the frequency of admissions with reprot to admission time = RtoA_array(i)
  - ageBreaks, LOS_array & LOS_freq - LOS_freq(i,j) is the frequency of admissions in age group with lower edge ageBreaks(i) and with LOS = LOS_array(j)


Apart from the hopsital occupancy data (covid-cases-in-hospital-counts-location.xlsx), the other data files described above are generated by the script extractDataForForecast.m
This script reads in confidential unit record data, calculates the aggregated datasets described above, and saves them in the /data/ folder.
To run this script, you will need to point it to the folder containing the unit record data by setting the variable 'readFolder'.
Set readDate to specify the datestamp(s) on the unit record data file(s) to be read.


# Results

Results from `runLatest.m` are saved in the `results` folder as CSV files /results/forecast_dataYYYY-MM-DD.csv and Matlab binary files /results/forecast_dataYYYY-MM-DD.mat
where date denotes the time stamp of the data file used to generate the results. 

These results files contain a table with the following fields:
  - forecastDate - forecast was produced using data available on this date
  - area         - name of the area the forecast if for (either National or a specified Region or Health District)
  - t            - date to which this row of the forecast applies 
  - Iq - 5th, 10th, ..., 95th quantiles of the number of cases infected on day t in the model fitted to data supplied on forecastDate
  - Cq - 5th, 10th, ..., 95th quantiles of the number of cases reported on day t in the model fitted to data supplied on forecastDate
  - Cq_smoothed - 5th, 10th, ..., 95th quantiles of the smoothed number of cases reported on day t in the model fitted to data supplied on forecastDate
  - Aq - 5th, 10th, ..., 95th quantiles of the number of new admissions on day t in the model fitted to data supplied on forecastDate
  - Dq - 5th, 10th, ..., 95th quantiles of the number of discharges on day t in the model fitted to data supplied on forecastDate
  - Hq - 5th, 10th, ..., 95th quantiles of the hospital occupancy on day t in the model fitted to data supplied on forecastDate

# Figures

`runLatest.m` saves graphs in a file /figures/forecast_areaName_dataYYYY-MM-DD.png
where areaName is either "National" or a specified Region or Health District, and the date denotes the time stamp of the data file used to generate the results. 

# Other 

Other results in the article and Supplementary Material can be generated by running specific scripts in this repo:
- Run 'testGPmodels.m' to visualise the fitted Gaussian process regression models on a specified dataset.
- Run 'compareDataDownloads.m' to compare time series for daily reported cases and daily new hospital admissions between a set of specified datasets.
- Run 'plotDistns.m' to calculate and plot the empirical distributions for onset-to-report time, report-to-admission time, and age-specific Covid-19 related length of hospital stay. 


 # Version history 

- Results in the 1st preprint version of the article (https://www.medrxiv.org/content/10.1101/2023.09.25.23296118v1) were generated using the commit tagged 'v1.0'.
- Results in the 2nd preprint version of the article (https://www.medrxiv.org/content/10.1101/2023.09.25.23296118v2) were generated using the commit tagged 'v1.1'.
